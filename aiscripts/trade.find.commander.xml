<?xml version="1.0" encoding="utf-8" ?>

<!-- Various code modifications to improve trader logic; more details please see README. -->

<diff>
    <!-- SECTION START Faster Trade Matching -->

    <!-- Station export wares: wait faster! -->
    <!-- Iterate per-ware, then per-space -->
    <replace sel="/aiscript[@name='trade.find.commander']/attention/actions/do_if[@value='$selloffers.count gt 0']/do_all[@exact='$selloffers.count']/do_all/wait">
        <!-- Reduce per-space waiting time -->
        <!-- original has min=1,max=3,since=2 -->
        <wait min="500ms" max="1.5s" sinceversion="2" />
    </replace>
    <replace sel="/aiscript[@name='trade.find.commander']/attention/actions/do_if[@value='$selloffers.count gt 0']/do_all[@exact='$selloffers.count']/wait">
        <!-- Reduce per-ware waiting time -->
        <!-- original has min=1,max=3,since=2 -->
        <wait min="500ms" max="1.5s" sinceversion="2" />
    </replace>

    <!-- Station import wares; wait faster! -->
    <!-- Iterate per-ware, then per-space -->
    <replace sel="/aiscript[@name='trade.find.commander']/attention/actions/do_if[@value='$buyoffers.count gt 0']/do_all[@exact='$buyoffers.count']/do_all[@exact='$buyspaces.count']/wait">
        <!-- Reduce per-space waiting time -->
        <!-- original has min=0.5,max=4,since=9 -->
        <wait min="250ms" max="2s" sinceversion="9" />
    </replace>
    <replace sel="/aiscript[@name='trade.find.commander']/attention/actions/do_if[@value='$buyoffers.count gt 0']/do_all[@exact='$buyoffers.count']/wait">
        <!-- Reduce per-ware waiting time -->
        <!-- original has min=4,max=10,since=9 -->
        <wait min="1.5s" max="4.5s" sinceversion="9" />
    </replace>

    <!-- SECTION END Faster Trade Matching -->

    <!-- SECTION START Trader Diversion -->

    <!-- Divert some traders to try importing first. -->
    <!-- This happens only once per trade search. -->
    <add sel="/aiscript[@name='trade.find.commander']/attention/actions/label[@name='sell']" pos="before">
        <do_if value="not $hasDivertedImporting?" chance="20" comment="Check whether we have done this before">
            <!-- Haven't done this diversion before; small chance to do diversion -->
            <!-- Jump to ware imports -->
            <set_value name="$hasDivertedImporting" exact="true" comment="Set and raise the flag" />
            <resume label="buy" />
        </do_if>
    </add>
    <add sel="/aiscript[@name='trade.find.commander']/attention/actions/do_if[@value='$usedshortage?']" pos="after">
        <!-- This is after the import script finished checking for trades (including "shortage trading"), but no trade found. -->
        <!-- The script then declares "no trade found". -->
        <do_if value="@$hasDivertedImporting">
            <!-- Actually, we did not try exporting. Let's get back to there! -->
            <set_value name="$hasDivertedImporting" exact="false" comment="Lower the flag but still keep it to prevent inf-loop" />
            <set_value name="$jumpSleep" comment="Simple flag to indicate next code section should be 'sleep'" />
            <resume label="start" />
        </do_if>
        <!-- Create a convenient label here because we will need it later. -->
        <label name="sleep" />
    </add>
    <add sel="/aiscript[@name='trade.find.commander']/attention/actions/label[@name='buy']" pos="before">
        <do_if value="$jumpSleep?">
            <!-- We diverted to importing, then returned to exporting, and then we are still here. -->
            <!-- This means "no trades found"; go to sleep!-->
            <remove_value name="$jumpSleep" />
            <resume label="sleep" />
        </do_if>
    </add>

    <!-- SECTION END Trader Diversion -->
</diff>
